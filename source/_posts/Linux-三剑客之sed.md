---
title: Linux 三剑客之sed
comments: true
excerpt: 未设置摘要
categories:
  - - Linux
tags:
  - Linux
toc: true
math: true
reward: false
top: false
date: 2022-05-18 08:54:35
---

## 前言

`sed`是一个非交互式流式编辑器，它可对文本文件和标准输入进行编辑(标准输入可以是来自键盘、文件重定向、字符串、变量、甚至是来自管道的文本)。

`sed`从文本的一个文本行或标准输入中读取数据，将其复制到缓冲区，然后读取命令行或脚本的第一个命令，对此命令要求的行号进行编辑，重复此过程，直到命令行或脚本中的所有命令都执行完毕。

`sed` 只是对缓冲区中原始文件的副本进行编辑，并**不编辑**原始文件。要保存改动的内容需要重定向到另外一个文件中：

```
sed [option] 'sed command' input-file > result-file
```

## 调用方式

1. 在`shell` 命令行中输入命令调用`sed`，格式为：

```
sed [option] 'sed command' file-name
```

在调用时，需要将`sed`命令用单引号引起来。

2. 将`sed`命令插入到脚本中调用时，需要添加参数`-f`,格式为：

```
sed [option] -f sed脚本文件 输入文件
```

## `sed` 命令解析

### 常用选项

`sed` 常用选项有三个：

- `-n`: 不打印所有行到标准输出。
- `-e`: 表示将下一个字符串解析为`sed`编辑命令,如果只传递一个编辑命令给`sed`，则`-e`选项可以忽略。
- `-f`: 表示正在调用`sed`脚本文件。

`sed` 命令通常由定位文本行和`sed`编辑命令两部分组成。

### `sed`定位文本的方法

`sed`提供两种定位文本的方法：

- 使用行号，指定一行，或指定行号范围。
- 使用正则表达式。

下面为`sed`命令定位文本的方法：

|       选项        |                意义                |
| :---------------: | :--------------------------------: |
|         x         |            x为指定行号             |
|        x,y        |         指定x到y的行号范围         |
|     /pattern/     |          查询包含模式的行          |
| /pattern/pattern/ |        查询包含两个模式的行        |
|    /pattern/,x    | 从与pattern的匹配行到x号行之间的行 |
|    x,/pattern/    | 从x号行到与pattern的匹配行之间的行 |
|       x,y!        |     查询不包括x和y行号之间的行     |

### `sed`编辑命令

| 选项 |                   意义                   |
| :--: | :--------------------------------------: |
|  p   |                打印匹配行                |
|  =   |               打印文件行号               |
|  a\  |        在定位行号之后追加文本信息        |
|  i\  |        在定位行号之前插入文本信息        |
|  d   |                删除定位行                |
|  c\  |           用新文本替换定位文本           |
|  s   |         使用替换模式替换相应模式         |
|  r   |         从另外一个文件中读取文本         |
|  w   |           将文本写入到一个文件           |
|  y   |               逐个替换字符               |
|  q   |         第一个模式匹配完成后退出         |
|  l   |    显示与八进制ASCII码等价的控制字符     |
|  {}  |           在定位行执行的命令组           |
|  n   | 读取下一个输入行，用下一个命令处理新的行 |
|  h   |  将pattern缓冲区的文本复制到hold缓冲区   |
|  H   |  将pattern缓冲区的文本追加到hold缓冲区   |
|  x   |  将pattern缓冲区和hold缓冲区的内容互换   |
|  g   |  将hold缓冲区的内容复制到pattern缓冲区   |
|  G   |  将hold缓冲区的内容追加到pattern缓冲区   |

## `sed`命令例子

1. `-n` 选项

``` 
# -n选项表示"不打印"是指: 不打印sed编辑对象的全部内容，将-n去掉就会打印文件内的全部内容
sed -n '1p' input 

# 打印input文件的3~6行
sed -n '3,6p' input

# sed命令打印匹配模式行
sed -n '/certificate/p' input
```

2. `-e`选项

```
# 打印内容及行号，传递两个编辑命令给sed
sed -n -e '/Certificate/p' -e '/Certificate/=' input
```

***注意：`sed`不支持同时带多个编辑命令的用法，如：***

```
sed -n 'Certificate/p=' input
```

***上面这种用法是错误的！！！***

`sed`带多个编辑命令格式有下面几种

- `sed [option] -e 'edit command 1' -e 'edit command 2 ...'`
- `sed -n '/Certificate/{p;=}' input`
- `sed 's/globus/GLOBUS/; s/seugrid/SEUGRID/' input`

3. `-f` 选项

`-f`选项只有调用`sed`脚本时才起作用，追加文本、插入文本、修改文本、删除文本和替换文本等功能往往需要几条`sed`命令来完成，所以会将这些命令写入到`sed`脚本文件中，然后调用`sed`脚本来完成。

追加文本的例子：

```
# append.sed
#!/bin/sed -f
/file:/a\    # a\ 表示此处换行添加文本
# 需要添加的内容
We append a new line.
We append another line.
```



4. `sed`编辑命令

   - `a\`：将指定文本的一行或多行追加到指定行后面。

     ```
     # 命令格式为：sed '指定地址a\追加文本' 输入文件
     # 上面指定地址用/pattern/或者行号的形式给出，用于定位新文本的追加位置,sed对a\后的文本进行追加操作
     sed '/file:/a\We append a new line.' input
     ```
     
   - `i\`：插入文本和追加文本类似区别仅在于追加文本是在匹配行的后面插入，而插入文本是在匹配行的前面插入。

   ```
   !#/bin/sed -f
   /file:/i\ # i\表示此处换行插入文本
   We insert a new line.
   ```

   - `c\`修改文本是指将所匹配的文本行里用心文本替代。

   ```
   #!/bin/sed -f 
   /file:/c\ # c\表示此处换行修改文本
   We modify this line.
   ```

   - `d` 删除文本

   `sed`删除文本命令可以指定行或者指定行范围进行删除。

   ***注意：`sed`编辑命令中删除操作符号是`d`，后面没有`\`符号。***

   ```
   # sed 命令删除第一行
   sed '1d' input
   
   # sed命令删除最后一行
   sed '$d' input
   
   # 删除指定范围内所有的行
   sed '1,10d' input
   
   # 删除第5行到最后一行
   sed '5,$d' input
   
   # 删除与pattern匹配的行
   sed '/[Cc][Ee][Rr][Tt][Ii][Ff][Ii][Cc][Aa][Tt][Ee]/d' input
   ```

   - `s`替换文本
   - 替换文本与修改文本之间的区别在于：***替换文本可以替换一个字符串，而修改文本是对整行进行修改***

   替换文本的格式为：

   ```
   s/被替换的字符串/新字符串/[替换选项]
   ```

   替换选项及其意义:

   |   选项   |                  意义                  |
   | :------: | :------------------------------------: |
   |    g     | 表示替换文本中所有出现被替换字符串之处 |
   |    p     |       与-n选项结合,只打印替换行        |
   | w 文件名 |        表示将输出定向到一个文件        |

   `P`选项：默认情况下，`sed`的`s`命令将替换后的全部文本都输出，如果只要求打印替换行，需要结合使用`-n`和`p`选项，命令格式如下：

   ```
   sed -n 's/被替换的字符串/新字符串/p' 输入文件
   ```

   上述命令如果缺少p选项,将不打印任何内容,`p`选项的官方文档解释是：使`-n`无效：

   ```
   # 1.不加-n和p选项,结果为:显示替换后文本的所有内容
   # 2.添加-n和p选项，结果为:仅显示被替换的行
   # 3.只添加-n参数,未添加p选项，结果为：不打印任何内容
   # 4.省略参数-n，只使用p选项,结果为：打印所有行，且匹配行重复打印。
   ```

   `sed`替换命令在不带`g`选项时，对某行的第一处匹配关键字进行替换后就跳转到下一匹配行进行操作。而`g`选项使得`sed`替换命令对某行中所有匹配的关键字都进行了替换。所以只有当被替换字符串在某行出现两次以上时，`g`选项才发挥作用。

   ```
   # sed替换命令w选项的用法
   # 将seu字符串改为njue，并将结果写入output文件
   sed -n 's/seu/njue/w output' input
   ```

   - `sed`替换文本中经常使用的`&`符号。

     `&`符号可用来保存被替换的字符串以供调用

     ```
     # 将seu用圆括号括起来
     sed -n 's/seu/(&)pg' input
     # 等价于
     sed -n 's/seu/(seu)/pg' input
     ```

   - 写入一个新文件

   ```
   # 指定地址 w 文件名
   # 将1~5行写入output文件
   sed -n '1,5 w output' input
   
   # 将与globus关键字匹配的行写入output文件
   sed -n '/globus/w output' input
   ```

   - 从文件中读文本

   ```
   # 在与Certificate匹配的行后读入otherfile文件
   sed '/Certificate/r otherfile' input
   ```

   - 退出命令

   ```
   # 打印input文件的前5行
   sed '5 q' input
   # 查找任意字符后跟r字符，再跟0个或多个任意字符的字符串,这种情况会匹配全部字符串
   sed -n '/.r.*/p' input
   
   # 匹配第一个字符串后立刻退出
   sed '/.r.*/q' input
   ```

   - 变换命令

   `sed`命令的`y`选项表示字符串变换，他将一系列的字符串变换为相应的字符，`y`选项是对字符的逐个处理，他的基本格式是：

   ```
   sed 'y/被变换的字符序列/变换的字符序列' 输入文件
   ```

   `sed`命令的`y`选项要求被变换的字符序列和变换的字符序列等长，否则会报错。

   ```
   # 将input文件中的1变换为A、2变换为B、3变换为C、4变换为D、5变换为E
   sed 'y/12345/ABCDE/' input
   
   # 将fmj三个字符变换为大写
   sed 'y/fmj/FMJ/' input
   ```

   - 显示控制字符

   ```
   # sed 显示控制字符
   # 表示用正则表达式'1,$'表示从第一行到最后一行,各系统的控制字符的显示值可能不同
   sed -n '1, $l' control
   ```

   

4. `sed`文本定位的一组例子

   - 匹配元字符：

   ```
   # 匹配字符中包含元字符时，需要用转义字符"\"屏蔽其特殊意义
   sed -n '/\./p' input
   sed -n '/\$/p' input
   ```

   - 使用元字符进行匹配

     `sed` 命令可以灵活使用正则表达式的元字符进行匹配。`$`在`sed`命令中表示最后一行：

     ``` 
     # sed结合$符号匹配最后一行
     sed -n '$p' input
     
     # sed基本编辑命令也可以放到引号外面
     sed -n '$'p input
     
     # 用.和*号匹配任意字符
     sed -n '/.*bus/p' input 
     ```

   - `!`符号表示取反, `x,y!`表示匹配不在`x`和`y`行号范围内的行。
     
     ```
     sed -n '2,10!p' input
     ```
     
     `x!`表示匹配除了`x`行号外的所有行,但是,`！`符号不能用于关键字匹配,如无法表示不与/pattern/匹配的行。
     
   - 使用行号与关键字匹配限定行范围

     ```
     # sed 命令使用行号与关键字匹配限定行范围
     
     # 打印与seugrid的匹配行到最后一行
     sed -n '/seugrid/,$p' input
     
     # 打印第三行到与Certificate的匹配行
     sed -n '3,/Certificate/p' input
     ```

### `sed`高级编辑命令的一组例子

1. 处理匹配行的下一行

`sed`编辑命令`n`的意义是读取下一个输入行，用`n`后面的一个命令处理该行，由于此时通常有多个编辑命令，所以，编辑命令`n`需要与`{}`符号结合使用。

```
# sed n编辑命令的用法
# 将与certificate匹配的下一行中的ll替换成99 
sed '/certificate/{n;s/ll/99/;}' input
```

2. `sed`缓冲区的处理

`sed`有两种缓冲区：模式缓冲区(Pattern Buffer) 和保持缓冲区(Hold Buffer)，一般操作的是Pattern Buffer，`sed`的一些命令可以操作Hold Buffer。

```
sed -e '/Subject/h' -e '/seugrid/x' -e '$G' input
# 上面命令中第一个-e选项后的编辑命令将Subject关键字的匹配行写入Hold Buffer中
# 第二个-e选项后的编辑命令是遇见seugrid关键字的匹配行时，将Hold Buffer中的内容输出，并将seugrid关键字的匹配行写入Hold Buffer
# 第三个-e选项后的编辑命令表示到最后一行时（用$进行匹配），将Hold Buffer中的内容追加到pattern Buffer中。
```

`h`和`H`、`g`和`G`是两组对应的命令，`h`和`H`命令是Pattern Buffer替换掉Hold Buffer的内容，不过`h`是副本，即将Hold Buffer的旧内容覆盖掉，而`H`是追加，即在Hold Buffer的旧内容的基础上，增加新的内容。

`g`和`G`命令是Hold Buffer内容替换Pattern Buffer内容，同理`g`是副本,`G`是追加。
